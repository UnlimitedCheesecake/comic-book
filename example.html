<!doctype html>
<html>
    <head>
        <title>COMICS!</title>
        <link rel="stylesheet" href="/static/css/main.css" />
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
        <style>
            body {
                color: #ffffff;
                font-family:Monospace;
                font-size:13px;
                text-align:center;
                font-weight: bold;
                background-color: #000000;
                margin: 0px;
                overflow: hidden;
            }

            #info {
                position: absolute;
                top: 0px; width: 100%;
                padding: 5px;
            }

            a {
                color: #ffffff;
            }
        </style>
    </head>
    <body>
        <div id="container"></div>
        <div id="info"><a href="http://threejs.org" target="_blank">three.js</a> render-to-texture webgl example</div>

        <script src="/static/js/three/three.min.js"></script>
        <script src="/static/js/three/stats.min.js"></script>
        <script src="/static/js/three/Detector.js"></script>


        <script src="/static/js/mock_image_getter.js"></script>
        <script id="fragment_shader_screen" type="x-shader/x-fragment">

            varying vec2 vUv;
            uniform sampler2D tDiffuse;

            void main() {

                gl_FragColor = texture2D( tDiffuse, vUv );

            }

        </script>

        <script id="vertexShader" type="x-shader/x-vertex">

            varying vec2 vUv;

            void main() {

                vUv = uv;
                gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

            }

        </script>


        <script>

            if ( ! Detector.webgl ) Detector.addGetWebGLMessage();

            var container, stats;

            var pageCamera, camera, pageScene, scene, renderer;
            var mouseX = 0, mouseY = 0;

            var windowHalfX = window.innerWidth / 2;
            var windowHalfY = window.innerHeight / 2;

            var comicFrames = [];
            var framePos = 0;

            var pageTexture, quad;
            var frameGeometry;
            var textureMaterial;

            var delta = 0.01;

            init();
            animate();

            function init() {

                container = document.getElementById( 'container' );

                // Camera viewing the composited page
                camera = new THREE.PerspectiveCamera( 30, window.innerWidth / window.innerHeight, 1, 10000 );
                camera.position.z = 100;

                // Camera viewing the individual frames on the flat page
                pageCamera = new THREE.PerspectiveCamera( 30, window.innerWidth / window.innerHeight, 1, 10000 );
                pageCamera.position.z = 100;

                scene = new THREE.Scene();
                pageScene = new THREE.Scene();

                // FIXME: we don't really want the lights in the pageScene
                var light = new THREE.DirectionalLight( 0xffffff );
                light.position.set( 0, 0, 1 ).normalize();
                pageScene.add( light );

                light = new THREE.DirectionalLight( 0xffaaaa, 1.5 );
                light.position.set( 0, 0, -1 ).normalize();
                pageScene.add( light );

                pageTexture = new THREE.WebGLRenderTarget(
                    window.innerWidth, window.innerHeight, {
                        minFilter: THREE.LinearFilter,
                        magFilter: THREE.NearestFilter,
                        format: THREE.RGBFormat
                });

                var pageMaterial = new THREE.ShaderMaterial( {

                    uniforms: { tDiffuse: { type: "t", value: pageTexture } },
                    vertexShader: document.getElementById( 'vertexShader' ).textContent,
                    fragmentShader: document.getElementById( 'fragment_shader_screen' ).textContent,

                    depthWrite: false

                } );



                var pageGeometryA4 = new THREE.PlaneGeometry( 1.0, 1.414285714 );
                quad = new THREE.Mesh( pageGeometryA4, pageMaterial );
                quad.scale.x = 400;
                quad.scale.y = 400;
                quad.position.z = -400;
                scene.add( quad );


                frameGeometry = new THREE.PlaneGeometry( 50, 50);

                renderer = new THREE.WebGLRenderer();
                renderer.setSize( window.innerWidth, window.innerHeight );
                renderer.autoClear = false;

                container.appendChild( renderer.domElement );

                stats = new Stats();
                stats.domElement.style.position = 'absolute';
                stats.domElement.style.top = '0px';
                container.appendChild( stats.domElement );

                document.addEventListener( 'mousemove', onDocumentMouseMove, false );

            }

            function onDocumentMouseMove( event ) {

                mouseX = ( event.clientX - windowHalfX );
                mouseY = ( event.clientY - windowHalfY );

            }

            //

            function animate() {

                requestAnimationFrame( animate );

                render();
                stats.update();

            }

            function render() {

                var time = Date.now() * 0.0015;

                camera.position.x += ( mouseX - camera.position.x ) * .05;
                camera.position.y += ( - mouseY - camera.position.y ) * .05;

                camera.lookAt( scene.position );

                for (var i=0; i<comicFrames.length; i++) {
                    comicFrames[i].position.x -= 0.01;
                }
                renderer.setClearColor(new THREE.Color(0x000000));
                renderer.clear();

                renderer.setClearColor(new THREE.Color(0xFFFFFF));
                renderer.clearTarget( pageTexture, 1, 1, 1);



                renderer.render( pageScene, pageCamera, pageTexture, true );
                renderer.render( scene, camera );

            }

            function addImage(texture) {
                var textureMaterial = new THREE.MeshBasicMaterial( { color: 0xffffff, map: texture } );
                framePos += 3;
                var frameMesh = new THREE.Mesh( frameGeometry, textureMaterial );
                frameMesh.position.z = 10* Math.random();
                frameMesh.position.x = framePos;
                frameMesh.position.y = 10* Math.random();
                pageScene.add( frameMesh );
                comicFrames.push(frameMesh);
            }

        </script>
    </body>
</html>
